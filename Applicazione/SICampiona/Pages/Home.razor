@*
  Nome del progetto: SICampiona
  Copyright (C) 2025 Agenzia regionale per la protezione dell'ambiente ligure

  Questo programma è software libero: puoi ridistribuirlo e/o modificarlo
  secondo i termini della GNU Affero General Public License pubblicata dalla
  Free Software Foundation, sia la versione 3 della licenza, sia (a tua scelta)
  qualsiasi versione successiva.

  Questo programma è distribuito nella speranza che possa essere utile,
  ma SENZA ALCUNA GARANZIA; senza nemmeno la garanzia implicita di
  COMMERCIABILITÀ o IDONEITÀ PER UNO SCOPO PARTICOLARE. Vedi la
  GNU Affero General Public License per ulteriori dettagli.

  Dovresti aver ricevuto una copia della GNU Affero General Public License
  insieme a questo programma. In caso contrario, vedi <https://www.gnu.org/licenses/>.
*@

@page "/"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using SICampiona.Model
@using SICampiona.Pages.Dialog
@using SICampiona.Services
@using SICampiona.Shared

@inject IConfigurazioneOperatoreService infoOperatore
@inject ICampionamentiStorage campionamentiStorage
@inject NavigationManager Navigation
@inject IHttpClientFactory clientFactory
@inject IDialogService DialogService
@inject IConfiguration Configuration
@inject ILogger<Home> logger
@inject IAccessTokenProvider AuthorizationService

<PageTitle>SICampiona</PageTitle>

<FluentLabel Typo="Typography.PageTitle" Class="pagetitle">Attività</FluentLabel>

<AvvisoErrore MessaggioErrore="@messaggioErrore"
              DettagliErrore="@dettagliErrore"
              VisualizzaComandoRicarica="@visualizzaComandoRicarica"
              VisualizzaComandoTornaHomePage="@visualizzaComandoTornaHomePage"
              VisualizzaComandoChiudi="@visualizzaComandoChiudi" />
@if (!string.IsNullOrEmpty(messaggioAggiornamentoVersione))
{
    <div style="background-color: lightyellow; border: 0.5px solid silver; padding: 10px; margin-bottom: 10px;">
        <FluentLabel Typo="Typography.Body">
            @messaggioAggiornamentoVersione
        </FluentLabel>
    </div>
}
<ConnessioneRete>
    <Online>
        @if (!aggiornamentoInCorso)
        {
            <FluentStack>
                @if (infoOperatore.Autorizzato)
                {
                    <FluentStack VerticalAlignment="VerticalAlignment.Center">
                        <FluentButton Appearance="Appearance.Accent" OnClick="@Nuovo">Nuovo</FluentButton>
                        <FluentButton Appearance="Appearance.Accent" OnClick="@Duplica">Duplica</FluentButton>
                        <FluentButton Appearance="Appearance.Accent" OnClick="@(()=>Sincronizzazione(true))">Sincronizza</FluentButton>
                        <FluentButton Appearance="Appearance.Accent" OnClick="@ArchivioCompletati">Campionamenti completati</FluentButton>
                        <FluentButton Appearance="Appearance.Accent" OnClick="@Pacchetti">Pacchetti ALIMS</FluentButton>
                        <FluentAnchor Href="@urlDocumentoAperturaCampioni" Target="_blank" Appearance="Appearance.Accent"
                                      IconEnd="@(new Icons.Regular.Size16.DocumentLink().WithColor(Color.Fill))">
                            Apertura campioni
                        </FluentAnchor>
                        @if (necessariaSincronizzazione)
                        {
                            <FluentIcon Value="@(new Icons.Regular.Size28.Info())" Color="@Color.Info" />
                            <FluentLabel> Sincronizzare per inviare le modifiche </FluentLabel>
                        }
                    </FluentStack>
                }
                <FluentStack HorizontalAlignment="HorizontalAlignment.Right">
                    @if (!infoOperatore.Autorizzato)
                    {
                        <FluentButton Appearance="Appearance.Accent" OnClick="@Login">Login SPID/CIE</FluentButton>
                    }
                    else
                    {
                        <FluentStack HorizontalAlignment="HorizontalAlignment.Right" VerticalAlignment="VerticalAlignment.Center">
                            <FluentLabel Typo="Typography.Body">Operatore: @infoOperatore.NomeCognome()</FluentLabel>
                            <FluentButton Appearance="Appearance.Accent" OnClick="@Logout">Logout</FluentButton>
                        </FluentStack>
                    }
                </FluentStack>
            </FluentStack>
        }
    </Online>
    <Offline>
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Icons.Regular.Size28.Warning())" Color="@Color.Warning" />
            <FluentLabel Typo="Typography.Body" Color="Color.Neutral"> Connessione di rete assente; alcune funzioni non sono disponibili. </FluentLabel>
        </FluentStack>
    </Offline>
</ConnessioneRete>

<div style="height: 5px; padding-top: 2px;">
    <FluentProgress Visible="@aggiornamentoInCorso"></FluentProgress>
</div>

<FluentStack Orientation="Orientation.Horizontal" Wrap="true">
    @if (campionamenti != null)
    {
        @foreach (var c in campionamenti)
        {
            <FluentCard Width="600px" Height="260px">
                <FluentStack Orientation="Orientation.Vertical">
                    <FluentStack VerticalAlignment="VerticalAlignment.Center" Style="border-bottom: 1px solid #888;">
                        <FluentLabel Typo="Typography.Header">
                            <a href="campionamento/@c.IdCampionamento" style="font-weight:bold; text-decoration: none;">@c.PuntoDiPrelievo</a>
                        </FluentLabel>
                        <FluentSpacer />
                        @if (c.Stato == "Completato")
                        {
                            <FluentBadge Appearance="Appearance.Neutral" Fill="lowlight" BackgroundColor="#080" Color="#fff">
                                @c.Stato
                            </FluentBadge>
                        }
                        @if (c.Stato == "Eliminato")
                        {
                            <FluentBadge Appearance="Appearance.Neutral" Fill="lowlight" BackgroundColor="#f00" Color="#fff">
                                @c.Stato
                            </FluentBadge>
                        }
                    </FluentStack>
                    <FluentLabel>
                        @c.Matrice
                    </FluentLabel>
                    <FluentLabel>
                        @c.Argomento
                    </FluentLabel>
                    <FluentLabel>
                        @c.Cliente
                    </FluentLabel>
                    <FluentLabel>
                        Data prelievo: @c.DataPrelievo
                    </FluentLabel>
                    <FluentStack HorizontalAlignment="HorizontalAlignment.Right">
                        @if (c.Stato == "Completato")
                        {
                            if (infoOperatore.Autorizzato && !string.IsNullOrEmpty(c.UrlPDFVerbale))
                            {
                                <ConnessioneRete>
                                    <Online>
                                        <FluentAnchor Href="@c.UrlPDFVerbale"
                                                      Target="_blank"
                                                      Appearance="Appearance.Outline"
                                                      IconStart="@(new Icons.Regular.Size20.DocumentArrowDown())">
                                            Verbale
                                        </FluentAnchor>
                                    </Online>
                                </ConnessioneRete>
                            }
                            else
                            {
                                <FluentLabel Disabled="true">Verbale non disponibile</FluentLabel>
                            }
                        }
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        }
    }
</FluentStack>
@if (!aggiornamentoInCorso && (campionamenti == null || (campionamenti.Count() == 0)))
{
    if (infoOperatore.Autorizzato)
    {
        <FluentLabel Alignment="HorizontalAlignment.Center">Non sono disponibili attività. Avviare la sincronizzazione.</FluentLabel>
    }
    else
    {
        <FluentLabel Alignment="HorizontalAlignment.Center">Non sono disponibili attività. Eseguire il login.</FluentLabel>
    }
}
