@*
  Nome del progetto: SICampiona
  Copyright (C) 2025 Agenzia regionale per la protezione dell'ambiente ligure

  Questo programma è software libero: puoi ridistribuirlo e/o modificarlo
  secondo i termini della GNU Affero General Public License pubblicata dalla
  Free Software Foundation, sia la versione 3 della licenza, sia (a tua scelta)
  qualsiasi versione successiva.

  Questo programma è distribuito nella speranza che possa essere utile,
  ma SENZA ALCUNA GARANZIA; senza nemmeno la garanzia implicita di
  COMMERCIABILITÀ o IDONEITÀ PER UNO SCOPO PARTICOLARE. Vedi la
  GNU Affero General Public License per ulteriori dettagli.

  Dovresti aver ricevuto una copia della GNU Affero General Public License
  insieme a questo programma. In caso contrario, vedi <https://www.gnu.org/licenses/>.
*@

@page "/campionamento/caricaverbalefirmato/{idCampionamento:int}"

@using Blazored.LocalStorage
@using SICampiona.Model
@using SICampiona.Pages.Visualizzazione
@using SICampiona.Services
@using SICampiona.Pages.Dialog

@inject ICampionamentiStorage campionamentiStorage
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IHttpClientFactory clientFactory
@inject ILogger<Home> logger
@inject ILocalStorageService localStorage
@inject IConfigurazioneOperatoreService infoOperatore

<FluentLabel Typo="Typography.PageTitle" Class="pagetitle">Campionamento - Caricamento verbale firmato</FluentLabel>

@if (campionamentoDaStorageLocale == null && infoCampionamentoCompletato == null)
{
    <FluentLabel Typo="Typography.Body" Color="Color.Warning"> Campionamento non trovato </FluentLabel>
}
else
{
    @* in base ai dati disponibili sono visualizzate le informazioni del campionamento o quelle del campionamento completato *@
    if (campionamentoDaStorageLocale != null)
    {
        <FluentLabel>
            <strong>Ente:</strong> @campionamentoDaStorageLocale.Ente.Denominazione
        </FluentLabel>
        <FluentLabel>
            <strong>Cliente:</strong> @campionamentoDaStorageLocale.Cliente.Denominazione
        </FluentLabel>
        <FluentLabel>
            <strong>Matrice:</strong> @campionamentoDaStorageLocale.Matrice.Denominazione
        </FluentLabel>
        <FluentLabel>
            <strong>Argomento:</strong> @campionamentoDaStorageLocale.Argomento.Denominazione
        </FluentLabel>
        <FluentLabel>
            <strong>Tipo campionamento:</strong> @campionamentoDaStorageLocale.TipoCampionamento
        </FluentLabel>
        <FluentLabel>
            <strong>Punto di prelievo ARPAL:</strong> <VisualizzaPuntoDiPrelievo PuntoDiPrelievo="@campionamentoDaStorageLocale.PuntoDiPrelievoARPAL" />
        </FluentLabel>
        <FluentLabel>
            <strong>Punto di prelievo operatore:</strong> <VisualizzaPuntoDiPrelievo PuntoDiPrelievo="@campionamentoDaStorageLocale.PuntoDiPrelievoInseritoDaOperatore" />
        </FluentLabel>
        <FluentStack>
            <FluentLabel>
                <strong>Data prelievo:</strong> @campionamentoDaStorageLocale.DataPrelievo
            </FluentLabel>
            <FluentLabel>
                <strong>Ora prelievo:</strong> @campionamentoDaStorageLocale.OraPrelievo
            </FluentLabel>
        </FluentStack>
    }
    else
    {
        <FluentLabel>
            <strong>Ente:</strong> @infoCampionamentoCompletato.DenominazioneEnte
        </FluentLabel>
        <FluentLabel>
            <strong>Cliente:</strong> @infoCampionamentoCompletato.DenominazioneCliente
        </FluentLabel>
        <FluentLabel>
            <strong>Matrice:</strong> @infoCampionamentoCompletato.DenominazioneMatrice
        </FluentLabel>
        <FluentLabel>
            <strong>Argomento:</strong> @infoCampionamentoCompletato.DenominazioneArgomento
        </FluentLabel>
        <FluentStack>
            <FluentLabel>
                <strong>Data prelievo:</strong> @infoCampionamentoCompletato.DataPrelievo
            </FluentLabel>
            <FluentLabel>
                <strong>Ora prelievo:</strong> @infoCampionamentoCompletato.OraPrelievo
            </FluentLabel>
        </FluentStack>
    }
    <div class="floating-button-container">
        <FluentStack>
            <FluentButton Appearance="Appearance.Accent" OnClick="@Chiudi">
                Chiudi
            </FluentButton>
        </FluentStack>
    </div>
    <FluentDivider></FluentDivider>
    <p>Questa funzione permette di aggiungere alle informazioni del campionamento una copia firmata del verbale caricando un file PDF. La dimensione massima del file è @dimensioneMassimaFileInMB MB</p>

    @if (!seFileCaricato)
    {
        <FluentStack Orientation="Orientation.Vertical">
            <FluentInputFile DragDropZoneVisible="false"
                             Mode="InputFileMode.SaveToTemporaryFolder"
                             Multiple="false"
                             AnchorId="SelezioneFileButton"
                             MaximumFileSize="@(dimensioneMassimaFileInMB * 1024 * 1024)"
                             Accept=".pdf"
                             OnCompleted="@SelezioneFileOnCompleted" />
            <FluentButton Id="SelezioneFileButton" Appearance="Appearance.Accent">
                Seleziona file
            </FluentButton>

            <FluentLabel>
                @informazioniFile
            </FluentLabel>

            <FluentLabel Color="Color.Error">
                @messaggioFileNonValido
            </FluentLabel>

            @if (seFileValido)
            {
                <FluentButton Appearance="Appearance.Accent" OnClick="@RichiestaConfermaCaricaFile">
                    Carica file
                </FluentButton>
            }
        </FluentStack>
    }
    else
    {
        if (!seErroreCaricamentoFile)
        {
            <FluentStack VerticalAlignment="VerticalAlignment.Center" HorizontalAlignment="HorizontalAlignment.Center">
                <FluentIcon Value="@(new Icons.Filled.Size28.Checkmark())" Color="@Color.Success" />
                <FluentLabel Typo="Typography.H3">File caricato correttamente</FluentLabel>
            </FluentStack>
        }
        else
        {
            <FluentStack VerticalAlignment="VerticalAlignment.Center" HorizontalAlignment="HorizontalAlignment.Center" Orientation="Orientation.Vertical">
                <FluentStack VerticalAlignment="VerticalAlignment.Center" HorizontalAlignment="HorizontalAlignment.Center" Orientation="Orientation.Horizontal">
                    <FluentIcon Value="@(new Icons.Filled.Size28.Warning())" Color="@Color.Error" />
                    <FluentLabel Typo="Typography.H3" Color="Color.Error">Errore durante il caricamento del file</FluentLabel>
                </FluentStack>
                <FluentLabel Typo="Typography.Body">@erroreCaricamentoFile</FluentLabel>
            </FluentStack>
        }
    }
}
