@*
  Nome del progetto: SICampiona
  Copyright (C) 2025 Agenzia regionale per la protezione dell'ambiente ligure

  Questo programma è software libero: puoi ridistribuirlo e/o modificarlo
  secondo i termini della GNU Affero General Public License pubblicata dalla
  Free Software Foundation, sia la versione 3 della licenza, sia (a tua scelta)
  qualsiasi versione successiva.

  Questo programma è distribuito nella speranza che possa essere utile,
  ma SENZA ALCUNA GARANZIA; senza nemmeno la garanzia implicita di
  COMMERCIABILITÀ o IDONEITÀ PER UNO SCOPO PARTICOLARE. Vedi la
  GNU Affero General Public License per ulteriori dettagli.

  Dovresti aver ricevuto una copia della GNU Affero General Public License
  insieme a questo programma. In caso contrario, vedi <https://www.gnu.org/licenses/>.
*@

@using System.Text.RegularExpressions
@implements IDialogContentComponent<InserimentoEmailContent>

<FluentLabel Style="font-size: 12px;">Per inserire più indirizzi separarli con una virgola.</FluentLabel>
<FluentTextField Value=@Content.ValoreInserito
                 Label=@Content.Etichetta
                 Maxlength=@Content.LunghezzaMassimaTesto
                 Size=@Content.LarghezzaCasella
                 ValueChanged=@ValoreModificato
                 Immediate="true">
</FluentTextField>

<FluentDialogFooter>
    @if (valoreValido == false)
    {
        <FluentLabel Color="Color.Error">Indirizzo non valido</FluentLabel>
    }
    <FluentSpacer />
    <FluentButton Appearance="Appearance.Accent" OnClick="@SaveAsync" Disabled="@salvataggioDisabilitato">Salva</FluentButton>
    <FluentButton Appearance="Appearance.Accent" OnClick="@CancelAsync">Annulla</FluentButton>
</FluentDialogFooter>
@code {

    [Parameter]
    public InserimentoEmailContent Content { get; set; } = default!;

    [CascadingParameter]
    public FluentDialog Dialog { get; set; }

    private bool valoreValido = false;
    private bool salvataggioDisabilitato = false;

    protected override void OnInitialized()
    {
        ValidaElencoIndirizzi();
        AbilitaConferma();
    }

    private void ValoreModificato(string valore)
    {
        Content.ValoreInserito = valore;
        ValidaElencoIndirizzi();
        AbilitaConferma();
    }

    private void AbilitaConferma()
    {
        salvataggioDisabilitato = (string.IsNullOrWhiteSpace(Content.ValoreInserito) && Content.Obbligatorio) || !valoreValido;
    }

    private async Task SaveAsync()
    {
        Content.ValoreInserito = Content.ValoreInserito.Replace(" ", "");
        await Dialog.CloseAsync(Content);
    }

    private async Task CancelAsync()
    {
        await Dialog.CancelAsync();
    }

    private void ValidaElencoIndirizzi()
    {
        if (string.IsNullOrWhiteSpace(Content.ValoreInserito))
        {
            valoreValido = true;
            return;
        }

        string emailRegex = @"^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$";
        string[] emails = Content.ValoreInserito.Split(',');
        foreach (string email in emails)
        {
            if (!Regex.IsMatch(email.Trim(), emailRegex))
            {
                valoreValido = false;
                return;
            }
        }
        valoreValido = true;
        return;
    }
}
