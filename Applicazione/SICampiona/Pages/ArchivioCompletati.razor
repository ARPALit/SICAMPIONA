@*
  Nome del progetto: SICampiona
  Copyright (C) 2025 Agenzia regionale per la protezione dell'ambiente ligure

  Questo programma è software libero: puoi ridistribuirlo e/o modificarlo
  secondo i termini della GNU Affero General Public License pubblicata dalla
  Free Software Foundation, sia la versione 3 della licenza, sia (a tua scelta)
  qualsiasi versione successiva.

  Questo programma è distribuito nella speranza che possa essere utile,
  ma SENZA ALCUNA GARANZIA; senza nemmeno la garanzia implicita di
  COMMERCIABILITÀ o IDONEITÀ PER UNO SCOPO PARTICOLARE. Vedi la
  GNU Affero General Public License per ulteriori dettagli.

  Dovresti aver ricevuto una copia della GNU Affero General Public License
  insieme a questo programma. In caso contrario, vedi <https://www.gnu.org/licenses/>.
*@

@page "/archivio"

@inject IArchivio archivio
@inject NavigationManager Navigation
@inject IConfigurazioneOperatoreService infoOperatore
@inject IDialogService DialogService
@inject ILocalStorageService localStorage

@using Blazored.LocalStorage
@using SICampiona.Pages.Dialog
@using SICampiona.Services
@using SICampiona.Model
@using SICampiona.Shared

<FluentLabel Typo="Typography.PageTitle" Class="pagetitle">Campionamenti completati</FluentLabel>

<AvvisoErrore MessaggioErrore="@messaggioErrore"
              DettagliErrore="@dettagliErrore"
              VisualizzaComandoRicarica="@visualizzaComandoRicarica"
              VisualizzaComandoChiudi="@visualizzaComandoChiudi"
              VisualizzaComandoTornaHomePage="@visualizzaComandoTornaHomePage" />

<FluentStack VerticalGap="10" Orientation="Orientation.Vertical">
    <div style="padding: 5px; background-color:#eee; border: 1px solid #ccc; margin-bottom: 10px;">
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentSelect TOption="ConfigurazioneOperatore.Ente"
                          Label="Ente:"
                          Items="@entiOperatore"
                          Id="enti-listbox"
                          OptionValue="@(p => p.Codice)"
                          OptionText="@(p => p.RagioneSociale)"
                          @bind-Value="@codiceEnte"
                          Height="200px"
                          SelectedOptionChanged="@((ConfigurazioneOperatore.Ente ente) => PopolaElencoClienti(ente.Codice))" />
            <FluentSelect TOption="Cliente"
                          Label="Cliente:"
                          Items="@clienti.AsQueryable()"
                          Id="clienti-listbox"
                          OptionValue="@(i => i.Codice)"
                          OptionText="@(i => i.Denominazione)"
                          Height="200px"
                          @bind-Value="@codiceCliente" />
            <FluentTextField Label="Sigla verbale:" @bind-Value="@siglaVerbale" />
            <FluentTextField Label="Numero campione:" @bind-Value="@numeroCampione" />
            <FluentDatePicker Label="Data prelievo:" @bind-Value="@dataPrelievo" />
            <FluentButton Title="Cancella"
                          OnClick="@(() => dataPrelievo= null)">
                <FluentIcon Value="@(new Icons.Regular.Size16.Backspace())" Color="Color.Neutral" />
            </FluentButton>
            <FluentButton IconEnd="@(new Icons.Regular.Size24.Search())"
                          OnClick="@Cerca" />
        </FluentStack>
    </div>
        <div style="padding: 5px; border: 1px solid #ccc;">

    <FluentDataGrid Items="@campionamenti"
                    EmptyContent="nessunDatoFragment"
                    Loading="@ricercaInCorso"
                    LoadingContent="ricercaInCorsoFragment">
        <PropertyColumn Property="@(c => c.DenominazioneCliente)" Title="Cliente" Class="multiline-text" />
        <PropertyColumn Property="@(c => c.DenominazioneMatrice)" Title="Matrice" Class="multiline-text" />
        <PropertyColumn Property="@(c => c.DenominazioneArgomento)" Title="Argomento" Class="multiline-text" />
        <PropertyColumn Property="@(c => c.DataPrelievo)" Title="Data prelievo" Class="multiline-text" />
        <PropertyColumn Property="@(c => c.SiglaVerbale)" Title="Sigla verbale" Class="multiline-text" />
        <PropertyColumn Property="@(c => c.NumeroCampione)" Title="Numero campione" Class="multiline-text" />
        <PropertyColumn Property="@(c => c.StatoCampione)" Title="Stato campione" Class="multiline-text" />
        <PropertyColumn Property="@(c => c.TemperaturaAccettazione)" Title="Temp. accettazione" Class="multiline-text" />
        <TemplateColumn Align="@Align.Start">
            <FluentStack Orientation="Orientation.Vertical">
                @if (!string.IsNullOrEmpty(context.UrlPDFRapportoDiProva))
                {
                    <FluentAnchor Href="@(context.UrlPDFRapportoDiProva)" Target="_blank" Appearance="Appearance.Hypertext">Rapporto di prova</FluentAnchor>
                }
                @if (!string.IsNullOrEmpty(context.UrlPDFVerbale))
                {
                    <FluentAnchor Href="@(context.UrlPDFVerbale)" Target="_blank" Appearance="Appearance.Hypertext">Verbale</FluentAnchor>
                }
                @if (!string.IsNullOrEmpty(context.UrlPDFVerbaleFirmato))
                {
                    <FluentAnchor Href="@(context.UrlPDFVerbaleFirmato)" Target="_blank" Appearance="Appearance.Hypertext">Verbale firmato</FluentAnchor>
                }
                else if (!string.IsNullOrEmpty(context.UrlPDFVerbale))
                {
                    <FluentButton Appearance="Appearance.Accent" @onclick="@(()=>CaricaVerbaleFirmato(context.IdCampionamento))">Carica verbale firmato</FluentButton>
                }
            </FluentStack>
        </TemplateColumn>

        <TemplateColumn Align="@Align.Center">
            <FluentButton Appearance="Appearance.Accent" @onclick="@(()=>Duplica(context.IdCampionamento, context.CodiceMatrice))">Duplica</FluentButton>
        </TemplateColumn>
    </FluentDataGrid>
    </div>
</FluentStack>

@if (campionamenti != null && campionamenti.Count() > 0)
{
    <FluentLabel Alignment="HorizontalAlignment.Center">@numeroMassimoRisultatiFragment</FluentLabel>
}

<div class="floating-button-container">
    <FluentStack>
        <FluentButton Appearance="Appearance.Accent" OnClick="@Chiudi">Chiudi</FluentButton>
    </FluentStack>
</div>

@code {
    IQueryable<ConfigurazioneOperatore.Ente> entiOperatore;
    List<Cliente> clienti = new List<Cliente>();
    string codiceEnte;
    string codiceCliente;
    string numeroCampione;
    string siglaVerbale;
    DateTime? dataPrelievo;
    IQueryable<InfoCampionamentoCompletato> campionamenti;

    // Vengono richiesti solo i primi x risultati
    int numeroMassimoRisultati = 100;
    RenderFragment numeroMassimoRisultatiFragment => @<FluentLabel>Sono mostrati solo i primi @numeroMassimoRisultati risultati.</FluentLabel>         ;

    private string nessunRisultato = "";
    RenderFragment nessunDatoFragment => @<FluentLabel>@nessunRisultato</FluentLabel>;
    RenderFragment ricercaInCorsoFragment => @<FluentProgressRing></FluentProgressRing> ;

    private bool ricercaInCorso = false;

    #region Gestione errore
    private string messaggioErrore = null;
    private string dettagliErrore;
    private bool visualizzaComandoRicarica = false;
    private bool visualizzaComandoChiudi = false;
    private bool visualizzaComandoTornaHomePage = false;
    #endregion

    protected override async Task OnInitializedAsync()
    {
        await PopolaElencoEnti();
    }

    private async Task PopolaElencoEnti()
    {
        if (!infoOperatore.Autorizzato)
        {
            messaggioErrore = "Non è stato possibile recuperare le informazioni dell'operatore";
            visualizzaComandoTornaHomePage = true;
            return;
        }
        entiOperatore = infoOperatore.Enti().AsQueryable();
        var enteSelezionato = entiOperatore.FirstOrDefault();
        codiceEnte = enteSelezionato?.Codice;
        await PopolaElencoClienti(enteSelezionato?.Codice);
    }

    private async Task PopolaElencoClienti(string codiceEnte)
    {
        var result = await archivio.ClientiCampionamentiCompletati(codiceEnte);
        nessunRisultato = "Nessun campionamento trovato";
        if (result.IsSuccess)
        {
            clienti = result.Data;
            clienti.Insert(0, new Cliente { Codice = null, Denominazione = string.Empty });
            StateHasChanged();
            codiceCliente = null;
        }
        else
        {
            messaggioErrore = "Non è stato possibile recuperare l'elenco dei clienti";
            dettagliErrore = $"{result.ErrorMessage} - {result.ErrorDetails}";
            visualizzaComandoRicarica = true;
            visualizzaComandoChiudi = false;
            visualizzaComandoTornaHomePage = true;
        }
    }

    private async Task Cerca()
    {
        ricercaInCorso = true;
        var ricerca = new RichiestaCampionamentiCompletati
            {
                CodiceEnte = codiceEnte,
                CodiceCliente = codiceCliente,
                NumeroCampione = numeroCampione,
                SiglaVerbale = siglaVerbale,
                DataCampionamento = dataPrelievo.HasValue ? DateOnly.FromDateTime(dataPrelievo.Value) : null,
                NumeroMassimoRisultati = numeroMassimoRisultati
            };
        var result = await archivio.ElencoCampionamentiCompletati(ricerca);
        if (result.IsSuccess)
        {
            campionamenti = result.Data.AsQueryable();
        }
        else
        {
            messaggioErrore = "Non è stato possibile recuperare l'elenco dei campionamenti";
            dettagliErrore = $"{result.ErrorMessage} - {result.ErrorDetails}";
            visualizzaComandoRicarica = true;
            visualizzaComandoChiudi = false;
            visualizzaComandoTornaHomePage = true;
        }
        ricercaInCorso = false;
    }

    private void Duplica(int idCampionamento, string codiceMatrice)
    {
        Navigation.NavigateTo($"./duplicacampionamentocompletato/{idCampionamento}/{codiceMatrice}");
    }

    private void Chiudi()
    {
        Navigation.NavigateTo("./");
    }

    private async Task CaricaVerbaleFirmato(int idCampionamento)
    {
        // Estrae le informzioni sul campionamento completato dai risultati della ricerca
        // e le mette in localstorage in modo che siano disponibili alla pagina CaricaVerbaleFirmato
        var infoCampionamentoCompletato = campionamenti.FirstOrDefault(c => c.IdCampionamento == idCampionamento);
        await localStorage.SetItemAsync("InfoCampionamentoCompletatoPerCaricamentoVerbale", infoCampionamentoCompletato);

        Navigation.NavigateTo($"campionamento/caricaverbalefirmato/{idCampionamento}");
    }
}
